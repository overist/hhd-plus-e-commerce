# Docker Compose for Multi-Server Load Testing
# 10대 서버 + 1대 Redis 환경 시뮬레이션
#
# 사용법:
#   1. 앱 이미지 빌드: docker build -t hhplus-ecommerce .
#   2. 스케일 실행: docker compose -f docker-compose.stage.yaml up --scale app=10
#   3. K6 부하 테스트: k6 run k6/issue-coupon.script.js
#   4. 종료: docker compose -f docker-compose.stage.yaml down

services:
  # ============================================
  # Infrastructure
  # ============================================
  mysql:
    image: mysql:8.0
    container_name: scale-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: 'root1234!'
      MYSQL_DATABASE: ecommerce_db
      MYSQL_USER: docker
      MYSQL_PASSWORD: docker
      TZ: 'UTC'
    ports:
      - '3306:3306'
    volumes:
      - ./infra/initdb:/docker-entrypoint-initdb.d
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost']
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: scale-redis
    restart: unless-stopped
    ports:
      - '6379:6379'
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 5

  # ============================================
  # Load Balancer (Nginx)
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: scale-nginx
    restart: unless-stopped
    ports:
      - '3000:80'
    volumes:
      - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - app

  # ============================================
  # Application (Scalable)
  # ============================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      NODE_ENV: stage
      DATABASE_URL: 'mysql://docker:docker@mysql:3306/ecommerce_db'
      REDIS_URL: 'redis://redis:6379'
      SESSION_SECRET: 'scale-test-secret'
      PORT: 3000
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    # 포트는 nginx가 로드밸런싱하므로 노출하지 않음
    expose:
      - '3000'
    deploy:
      # docker compose up --scale app=10 으로 오버라이드 가능
      replicas: 1
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

networks:
  default:
    name: scale-test-network
