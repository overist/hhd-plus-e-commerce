# 캐시 성능 개선 보고서

## 1. 개요

### 1.1 목적

이커머스 플랫폼의 **인기 상품 조회 API**(`GET /api/products/top`)에 캐시를 적용하여 응답 시간을 단축하고 데이터베이스 부하를 줄이는 것을 목표로 합니다.

### 1.2 테스트 환경

| 항목                 | 사양                                  |
| -------------------- | ------------------------------------- |
| **테스트 일시**      | 2025-11-28                            |
| **Framework**        | NestJS + @nestjs/cache-manager v3.0.1 |
| **Database**         | MySQL 8.0 (Docker)                    |
| **Cache**            | Memory / Redis 8.4.0 (Docker)         |
| **부하 테스트 도구** | K6                                    |
| **테스트 시나리오**  | 100 req/s, 30초 지속 (총 3,000 요청)  |

### 1.3 테스트 대상 API

```
GET /api/products/top
```

- **기능**: 최근 3일간 판매량 기준 인기 상품 Top 5 조회
- **특성**: 읽기 전용, 높은 조회 빈도, 데이터 갱신 주기 낮음 (1일 1회 스냅샷)

---

## 2. 캐시 전략 비교

### 2.1 테스트 시나리오

| 시나리오         | 설명                             | 캐시 저장소  |
| ---------------- | -------------------------------- | ------------ |
| **No Cache**     | 캐시 미적용, 매 요청마다 DB 조회 | -            |
| **Memory Cache** | 프로세스 내 인메모리 캐시        | Node.js Heap |
| **Redis Cache**  | 외부 Redis 서버 캐시             | Redis 8.4.0  |

### 2.2 구현 방식

```typescript
// 컨트롤러에 Interceptor 기반 캐시 적용
@UseInterceptors(HttpCacheInterceptor)
@CacheKey(CACHE_KEYS.PRODUCTS_TOP)
@CacheTTL(CACHE_TTL.TEN_MINUTES)
@Get('top')
async getTopProducts() { ... }
```

**캐시 설정:**

- **TTL**: 10분 (600,000ms)
- **무효화**: 일일 스냅샷 생성 시 자동 무효화

---

## 3. 성능 테스트 결과

### 3.1 응답 시간 비교

| 지표        | No Cache | Memory Cache | Redis Cache |
| ----------- | -------- | ------------ | ----------- |
| **Average** | 3.35ms   | 1.44ms       | 2.02ms      |
| **Median**  | 3.14ms   | 1.54ms       | 2.08ms      |
| **P90**     | 4.14ms   | 1.78ms       | 2.62ms      |
| **P95**     | 4.46ms   | 2.10ms       | 3.11ms      |
| **P99**     | 5.74ms   | 3.14ms       | 4.14ms      |
| **Min**     | 1.53ms   | 0.50ms       | 0.50ms      |
| **Max**     | 11.48ms  | 11.89ms      | 13.64ms     |

### 3.2 성능 개선율

```
┌─────────────────────────────────────────────────────────────────┐
│                     평균 응답시간 비교 (ms)                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  No Cache      ████████████████████████████████████  3.35ms     │
│                                                                 │
│  Redis Cache   ████████████████████                  2.02ms     │
│                                                        ↑        │
│  Memory Cache  ██████████████                        1.44ms     │
│                                                        ↑        │
│                                                                 │
│                ▼ 40% 감소        ▼ 57% 감소                     │
└─────────────────────────────────────────────────────────────────┘
```

| 비교                       | 평균 응답시간 개선 | P95 응답시간 개선 |
| -------------------------- | ------------------ | ----------------- |
| No Cache → Memory Cache    | **57% 감소**       | **53% 감소**      |
| No Cache → Redis Cache     | **40% 감소**       | **30% 감소**      |
| Redis Cache → Memory Cache | **29% 차이**       | **32% 차이**      |

---

## 4. 분석

### 4.1 캐시별 특성

#### Memory Cache (인메모리)

```
┌─────────────┐
│   NestJS    │
│  ┌───────┐  │
│  │ Cache │  │  ← 프로세스 내 메모리
│  └───────┘  │
└─────────────┘
```

**장점:**

- 네트워크 오버헤드 없음 (최고 성능)
- 추가 인프라 불필요
- 설정 단순

**단점:**

- 인스턴스 간 캐시 공유 불가
- 서버 재시작 시 캐시 손실
- 메모리 사용량 증가

#### Redis Cache (외부 저장소)

```
┌─────────────┐     ┌─────────────┐
│  NestJS 1   │────▶│             │
└─────────────┘     │    Redis    │
┌─────────────┐────▶│   (Cache)   │
│  NestJS 2   │     │             │
└─────────────┘     └─────────────┘
```

**장점:**

- 분산 서버 환경에서 인메모리 캐시 대비 DB 업데이트에 따른 캐시 삭제시 전파 용이
- 서버 재시작에도 캐시 유지
- 대용량 캐시 저장 가능

**단점:**

- 네트워크 RTT 추가 (~0.5ms)
- 압축, 자료구조 등 적용 시 직렬화/역직렬화 비용

---

## 5. 아키텍처

### 5.1 Redis 3분리 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                      Redis 3개 분리 구성                         │
├─────────────────────────────────────────────────────────────────┤
│  :6379  │  Session Redis  │  세션 저장    │  noeviction        │
│  :6380  │  Lock Redis     │  분산 락      │  noeviction        │
│  :6381  │  Cache Redis    │  API 캐시     │  allkeys-lru       │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 캐시 키 관리

- `products/top`: 인기 상품 조회 결과 캐시
- `products?page={n}&limit={m}`: 페이지네이션 상품 목록 캐시
- URI 내 패턴을 동일하게 적용하여 URL Path와 Query Parameter를 조합하여 고유 키 생성

### 5.3 캐시 무효화 전략

```typescript
// 일일 스냅샷 생성 시 캐시 무효화
@Cron(CronExpression.EVERY_DAY_AT_MIDNIGHT)
async updatePopularitySnapshot() {
  await this.productService.createPopularitySnapshot();

  // 캐시 무효화
  await this.cacheManager.del(CACHE_KEYS.PRODUCTS_TOP);
}
```

---

## 6. 테스트 재현 방법

```bash
# 1. 인프라 실행
pnpm infra:up

# 2. 앱 실행
pnpm start:dev

# 3. K6 테스트 실행
k6 run k6/top-products-cache.script.js

# 4. 시나리오 변경 (spike/stress)
k6 run -e SCENARIO=spike k6/top-products-cache.script.js
```

---

**작성일**: 2025-11-28  
**테스트 도구**: K6, Docker, NestJS
