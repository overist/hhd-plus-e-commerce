# 📋 ProcessOrder Usecase 이벤트 흐름 다이어그램 문서

> 이 문서는 애플리케이션의 유즈케이스와 이벤트 기반 아키텍처를 설명합니다.

---

## 📑 목차

1. [이벤트 흐름 다이어그램](#이벤트-흐름-다이어그램)
2. [결제 처리 이벤트 상세](#결제-처리-이벤트-상세)
3. [보상 트랜잭션 흐름](#보상-트랜잭션-흐름)

---

## 🔄 이벤트 흐름 다이어그램

### 이벤트 기반 아키텍처 전체 구조

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        EVENT-DRIVEN ARCHITECTURE                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│                     ┌──────────────────────────────┐                        │
│                     │   ProcessPaymentUseCase     │                        │
│                     │   (결제 처리 - 이벤트 발행자)  │                        │
│                     └──────────────┬───────────────┘                        │
│                                    │                                        │
│        ┌───────────────────────────┼───────────────────────────┐           │
│        │                           │                           │           │
│        ▼                           ▼                           ▼           │
│  ┌───────────┐             ┌───────────┐             ┌───────────┐         │
│  │ order.    │             │ order.    │             │ order.    │         │
│  │processing │             │ payment   │             │ processed │         │
│  └─────┬─────┘             └─────┬─────┘             └─────┬─────┘         │
│        │                         │                         │               │
│        │ (동기)                   │ (동기)                   │ (비동기)      │
│        │                         │                         │               │
│   ┌────┴────┐                    │                   ┌─────┴─────┐        │
│   │         │                    │                   │           │        │
│   ▼         ▼                    ▼                   ▼           ▼        │
│ ┌───┐    ┌───┐               ┌───────┐          ┌───────┐   ┌───────┐    │
│ │ P │    │ C │               │  User │          │Product│   │ Order │    │
│ │ r │    │ o │               │Listener│          │Listener│   │Listener│    │
│ │ o │    │ u │               │(잔액   │          │(판매   │   │(데이터 │    │
│ │ d │    │ p │               │ 차감)  │          │ 집계)  │   │플랫폼) │    │
│ │ u │    │ o │               └───┬───┘          └───────┘   └───────┘    │
│ │ c │    │ n │                   │                                        │
│ │ t │    │   │                   │ 실패 시                                 │
│ │   │    │ L │                   ▼                                        │
│ │ L │    │ i │           ┌──────────────┐                                 │
│ │ i │    │ s │           │order.payment │                                 │
│ │ s │    │ t │           │    .fail     │                                 │
│ │ t │    │ e │           └──────┬───────┘                                 │
│ │ e │    │ n │                  │                                         │
│ │ n │    │ e │      ┌───────────┼───────────┐                            │
│ │ e │    │ r │      │           │           │                            │
│ │ r │    │   │      ▼           ▼           ▼                            │
│ └─┬─┘    └─┬─┘   ┌──────┐  ┌──────┐  ┌──────┐                            │
│   │        │     │Product│  │Coupon│  │Order │                            │
│   │        │     │롤백   │  │롤백   │  │상태   │                            │
│   │ 실패 시 │     │      │  │      │  │롤백   │                            │
│   │        │     └──────┘  └──────┘  └──────┘                            │
│   ▼        ▼                                                              │
│ ┌────────────────┐                                                        │
│ │order.processing│                                                        │
│ │     .fail      │                                                        │
│ └───────┬────────┘                                                        │
│         │                                                                  │
│    ┌────┴────┐                                                            │
│    │         │                                                            │
│    ▼         ▼                                                            │
│ ┌──────┐ ┌──────┐                                                         │
│ │Product│ │Coupon│                                                         │
│ │롤백   │ │롤백   │                                                         │
│ └──────┘ └──────┘                                                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📝 결제 처리 이벤트 상세

### ProcessPaymentUseCase 이벤트 흐름

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                     ProcessPaymentUseCase 실행 흐름                           │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │ STEP 0: 초기화                                                          │ │
│  │ ─────────────────────────────────────────────────────────────────────── │ │
│  │  • Redis 분산락 획득 (payment:order:{orderId})                          │ │
│  │  • 주문 조회 및 소유권 검증                                              │ │
│  │  • 주문 상태 변경 (PENDING → PAID)                                       │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                        │
│                                      ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │ STEP 1: order.processing 이벤트 발행 (동기)                             │ │
│  │ ─────────────────────────────────────────────────────────────────────── │ │
│  │                                                                          │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │ OrderProcessingEvent                                              │  │ │
│  │  │  • orderId, userId, couponId                                      │  │ │
│  │  │  • order, orderItems                                              │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │                              │                                           │ │
│  │           ┌──────────────────┴──────────────────┐                       │ │
│  │           ▼                                     ▼                       │ │
│  │  ┌─────────────────────────┐      ┌─────────────────────────┐          │ │
│  │  │ Product:                │      │ Coupon:                 │          │ │
│  │  │ OnOrderProcessingListener│      │ OnOrderProcessingListener│          │ │
│  │  │ ───────────────────────  │      │ ───────────────────────  │          │ │
│  │  │ • 재고 확정 차감 (DB)    │      │ • 쿠폰 사용 처리 (Redis) │          │ │
│  │  │ • 비관적 잠금 FOR UPDATE │      │ • DB 동기화             │          │ │
│  │  └─────────────────────────┘      └─────────────────────────┘          │ │
│  │           │                                     │                       │ │
│  │           └──────────────────┬──────────────────┘                       │ │
│  │                              ▼                                           │ │
│  │                    결과 검증 (error 체크)                                │ │
│  │                    실패 시 → Exception 전파                              │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                        │
│                                      ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │ STEP 2: order.payment 이벤트 발행 (동기)                                │ │
│  │ ─────────────────────────────────────────────────────────────────────── │ │
│  │                                                                          │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │ OrderPaymentEvent                                                 │  │ │
│  │  │  • orderId, userId, couponId                                      │  │ │
│  │  │  • order (쿠폰 적용된 최종 금액 포함), orderItems                   │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │                              │                                           │ │
│  │                              ▼                                           │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐    │ │
│  │  │ User: OnOrderPaymentListener                                    │    │ │
│  │  │ ─────────────────────────────────────────────────────────────── │    │ │
│  │  │ • 사용자 잔액 차감 (낙관적 잠금 + 재시도)                        │    │ │
│  │  │ • 잔액 변경 이력 기록                                           │    │ │
│  │  └─────────────────────────────────────────────────────────────────┘    │ │
│  │                              │                                           │ │
│  │                    결과 검증 (error 체크)                                │ │
│  │                    실패 시 → Exception 전파                              │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                        │
│                                      ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │ STEP 3: order.processed 이벤트 발행 (비동기 - Fire & Forget)            │ │
│  │ ─────────────────────────────────────────────────────────────────────── │ │
│  │                                                                          │ │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │ │
│  │  │ OrderProcessedEvent                                               │  │ │
│  │  │  • orderId, userId, couponId, order, orderItems                   │  │ │
│  │  └───────────────────────────────────────────────────────────────────┘  │ │
│  │                              │                                           │ │
│  │           ┌──────────────────┴──────────────────┐                       │ │
│  │           ▼                                     ▼                       │ │
│  │  ┌─────────────────────────┐      ┌─────────────────────────┐          │ │
│  │  │ Order:                  │      │ Product:                │          │ │
│  │  │ OnOrderProcessedListener│      │ OnOrderProcessedListener│          │ │
│  │  │ ───────────────────────  │      │ ───────────────────────  │          │ │
│  │  │ • 데이터 플랫폼 전송    │      │ • 판매 랭킹 업데이트     │          │ │
│  │  │   (외부 시스템 연동)    │      │   (Redis 인기상품 집계) │          │ │
│  │  └─────────────────────────┘      └─────────────────────────┘          │ │
│  │                                                                          │ │
│  │  ※ 실패해도 결제에는 영향 없음                                          │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔙 보상 트랜잭션 흐름

### 실패 시 롤백 처리 구조

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                          보상 트랜잭션 (Saga Pattern)                         │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │ CASE 1: order.processing 단계 실패                                      │ │
│  │ ─────────────────────────────────────────────────────────────────────── │ │
│  │                                                                          │ │
│  │  [실패 원인]                                                             │ │
│  │  • 재고 부족 (ConfirmStockByOrder 실패)                                 │ │
│  │  • 쿠폰 사용 실패 (UseUserCouponByOrder 실패)                           │ │
│  │                                                                          │ │
│  │                     ┌─────────────────────┐                              │ │
│  │                     │ order.processing    │                              │ │
│  │                     │     .fail           │                              │ │
│  │                     └──────────┬──────────┘                              │ │
│  │                                │                                         │ │
│  │              ┌─────────────────┴─────────────────┐                      │ │
│  │              ▼                                   ▼                      │ │
│  │  ┌─────────────────────────┐      ┌─────────────────────────┐          │ │
│  │  │ Product:                │      │ Coupon:                 │          │ │
│  │  │ OnOrderFailListener     │      │ OnOrderProcessingFail   │          │ │
│  │  │ ─────────────────────── │      │ Listener                │          │ │
│  │  │ • 재고 복구             │      │ ─────────────────────── │          │ │
│  │  │   (부분 롤백 시도)      │      │ • 쿠폰 사용 취소        │          │ │
│  │  │                         │      │   (Redis 롤백)          │          │ │
│  │  └─────────────────────────┘      └─────────────────────────┘          │ │
│  │                                                                          │ │
│  │  ※ 재고 리스너 자체 실패 시: 부분적으로 처리된 재고 롤백 시도           │ │
│  │  ※ 쿠폰 리스너 자체 실패 시: 쿠폰 롤백 스킵 (이미 처리 안됨)           │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │ CASE 2: order.payment 단계 실패                                         │ │
│  │ ─────────────────────────────────────────────────────────────────────── │ │
│  │                                                                          │ │
│  │  [실패 원인]                                                             │ │
│  │  • 잔액 부족 (UserBalanceDeductByOrder 실패)                            │ │
│  │                                                                          │ │
│  │                     ┌─────────────────────┐                              │ │
│  │                     │ order.payment       │                              │ │
│  │                     │     .fail           │                              │ │
│  │                     └──────────┬──────────┘                              │ │
│  │                                │                                         │ │
│  │        ┌───────────────────────┼───────────────────────┐                │ │
│  │        ▼                       ▼                       ▼                │ │
│  │  ┌───────────────┐      ┌───────────────┐      ┌───────────────┐       │ │
│  │  │ Product:      │      │ Coupon:       │      │ Order:        │       │ │
│  │  │ OnOrderFail   │      │ OnOrderFail   │      │ OnOrderFail   │       │ │
│  │  │ Listener      │      │ Listener      │      │ Listener      │       │ │
│  │  │ ───────────── │      │ ───────────── │      │ ───────────── │       │ │
│  │  │ • 재고 복구   │      │ • 쿠폰 사용   │      │ • 주문 상태   │       │ │
│  │  │   (확정→선점) │      │   취소        │      │   롤백        │       │ │
│  │  │               │      │ • DB 동기화   │      │ (PAID→PENDING)│       │ │
│  │  │               │      │   삭제        │      │               │       │ │
│  │  └───────────────┘      └───────────────┘      └───────────────┘       │ │
│  │                                                                          │ │
│  │  ※ order.processing에서 성공한 모든 처리를 롤백                         │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 이벤트 매트릭스

### 이벤트-리스너 매핑 테이블

| 이벤트                  | 발행자                       | 구독자 (리스너)                       | 처리 내용          | 동기/비동기 |
| ----------------------- | ---------------------------- | ------------------------------------- | ------------------ | ----------- |
| `order.processing`      | ProcessPaymentUseCase        | Product: OnOrderProcessingListener    | 재고 확정 차감     | 동기        |
| `order.processing`      | ProcessPaymentUseCase        | Coupon: OnOrderProcessingListener     | 쿠폰 사용 처리     | 동기        |
| `order.payment`         | ProcessPaymentUseCase        | User: OnOrderPaymentListener          | 잔액 차감          | 동기        |
| `order.processed`       | ProcessPaymentUseCase        | Order: OnOrderProcessedListener       | 데이터 플랫폼 전송 | 비동기      |
| `order.processed`       | ProcessPaymentUseCase        | Product: OnOrderProcessedListener     | 판매 랭킹 업데이트 | 비동기      |
| `order.processing.fail` | 각 리스너 (실패 시)          | Product: OnOrderFailListener          | 재고 롤백          | 동기        |
| `order.processing.fail` | 각 리스너 (실패 시)          | Coupon: OnOrderProcessingFailListener | 쿠폰 롤백          | 동기        |
| `order.payment.fail`    | User: OnOrderPaymentListener | Product: OnOrderFailListener          | 재고 롤백          | 동기        |
| `order.payment.fail`    | User: OnOrderPaymentListener | Coupon: OnOrderFailListener           | 쿠폰 롤백          | 동기        |
| `order.payment.fail`    | User: OnOrderPaymentListener | Order: OnOrderFailListener            | 주문 상태 롤백     | 동기        |

---

## 🔒 동시성 제어 전략

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                           동시성 제어 메커니즘                                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │ 🔴 Redis 분산락                                                         │ │
│  │ ─────────────────────────────────────────────────────────────────────── │ │
│  │ • 대상: 주문 결제 (payment:order:{orderId})                             │ │
│  │ • TTL: 10초                                                             │ │
│  │ • 목적: 동일 주문에 대한 중복 결제 방지                                  │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │ 🟡 DB 비관적 잠금 (FOR UPDATE)                                          │ │
│  │ ─────────────────────────────────────────────────────────────────────── │ │
│  │ • 대상: 상품 옵션별 재고                                                │ │
│  │ • 목적: 재고 초과 판매 방지                                             │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │ 🟢 DB 낙관적 잠금 + 재시도                                              │ │
│  │ ─────────────────────────────────────────────────────────────────────── │ │
│  │ • 대상: 사용자 잔액                                                     │ │
│  │ • 버전 필드를 통한 충돌 감지                                            │ │
│  │ • 목적: 동시 잔액 변경 충돌 해결                                        │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │ 🔵 Redis Lua 스크립트 (원자적 처리)                                     │ │
│  │ ─────────────────────────────────────────────────────────────────────── │ │
│  │ • 대상: 쿠폰 발급 및 사용                                               │ │
│  │ • 중복 체크 + 재고 차감 + UserCoupon 생성 원자적 실행                   │ │
│  │ • 목적: 쿠폰 중복 발급/사용 방지                                        │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                               │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 📁 파일 구조

```
src/
├── order/
│   └── application/
│       ├── create-order.use-case.ts        # 주문 생성
│       ├── process-payment.use-case.ts     # 결제 처리 (이벤트 발행)
│       ├── get-orders.use-case.ts          # 주문 목록 조회
│       ├── get-order-detail.use-case.ts    # 주문 상세 조회
│       ├── events/
│       │   ├── order-processing.event.ts       # 결제 진행 이벤트
│       │   ├── order-processing-fail.event.ts  # 결제 진행 실패 이벤트
│       │   ├── order-payment.event.ts          # 결제 완료 이벤트
│       │   ├── order-payment-fail.event.ts     # 결제 완료 실패 이벤트
│       │   └── order-processed.event.ts        # 주문 처리 완료 이벤트
│       └── listeners/
│           ├── on-order-processed.listener.ts  # 데이터 플랫폼 전송
│           └── on-order-fail.listener.ts       # 주문 상태 롤백
│
├── product/
│   └── application/
│       ├── get-products.use-case.ts        # 상품 목록 조회
│       ├── get-product-detail.use-case.ts  # 상품 상세 조회
│       ├── get-top-products.use-case.ts    # 인기 상품 조회
│       ├── update-stock.use-case.ts        # 재고 수정
│       └── listeners/
│           ├── on-order-processing.listener.ts # 재고 확정 차감
│           ├── on-order-processed.listener.ts  # 판매 랭킹 업데이트
│           └── on-order-fail.listener.ts       # 재고 롤백
│
├── coupon/
│   └── application/
│       ├── issue-coupon.use-case.ts        # 쿠폰 발급
│       ├── get-user-coupons.use-case.ts    # 보유 쿠폰 조회
│       └── listeners/
│           ├── on-order-processing.listener.ts # 쿠폰 사용 처리
│           └── on-order-fail.listener.ts       # 쿠폰 롤백
│
├── user/
│   └── application/
│       ├── get-balance.use-case.ts         # 잔액 조회
│       ├── get-balance-logs.use-case.ts    # 잔액 변경 이력 조회
│       ├── charge-balance.use-case.ts      # 잔액 충전
│       └── listeners/
│           └── on-order-payment.listener.ts    # 잔액 차감
│
└── cart/
    └── application/
        ├── get-cart.use-case.ts            # 장바구니 조회
        ├── add-cart.use-case.ts            # 장바구니 추가
        └── remove-cart.use-case.ts         # 장바구니 삭제
```

---

> 📅 문서 최종 수정일: 2025년 12월 9일
